#!/bin/sh

##
# edit: backend script of the MailMate MacVim bundle, used to invoke vim
#
# Original author: O'Shaughnessy Evans <shaug+mailmate@wumpus.org>
#
# 2015-11-02: Modified by Mark Sprevak <http://sites.google.com/site/msprevak>
# - open buffer (fast), rather than launching new MacVim process (slow), for each message
# - send arbitrary Ex commands to MacVim on opening message (default is `set filetype=markdown`)
##

MVIM=/usr/local/bin/mvim
PATH=$HOME/bin:~/Applications/MacVim.app/Contents/MacOS:/Applications/MacVim.app/Contents/MacOS:/usr/local/bin:$PATH

# Ex commands to run on opening message
CMD=''\
'set filetype=markdown | '\
'redraw!'

# check if mvim already running
SERVERS=$($MVIM --serverlist)

if [ -z "$SERVERS" ]; then
    # Open new mvim instance
    $MVIM +"$CMD" "${MM_EDIT_FILEPATH}"
else
    # load file in current mvim instance
    $MVIM --remote "${MM_EDIT_FILEPATH}"
    $MVIM --remote-send ":$CMD<CR>"
fi
